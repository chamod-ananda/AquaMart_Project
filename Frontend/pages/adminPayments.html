<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>AquaMart - Admin Payments</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
	<link rel="stylesheet" href="../assets/css/navigation.css" />
	<link rel="stylesheet" href="../assets/css/responsive.css" />
	<style>
		body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(to bottom right, #a6ffea, #596dcd); margin: 0; min-height: 100vh; }
		.main { margin-left: 240px; padding: 2rem; }
		.card { border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); overflow: hidden; }
		.stat-card { background: white; border-radius: 12px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
		.table thead th { background: #2C2A7B; color: #fff; }
		.badge-soft { background: #eef2ff; color: #2C2A7B; }
	</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar d-flex flex-column">
	<h4>ÔøΩ <strong>AquaMart</strong></h4>
	<nav class="nav flex-column mt-4">
      <a class="nav-link active" href="adminDashboard.html" data-page="admin">üëë Admin Panel</a>
      <a class="nav-link" href="adminListing.html" data-page="listings">üìÑ Listings</a>
      <a class="nav-link" href="adminPayments.html" data-page="payments">üí≥ Payments</a>
      <a class="nav-link" href="adminSetting.html" data-page="setting">‚öôÔ∏è Setting</a>
      <a class="nav-link mt-auto" href="#" onclick="window.barkBuddyNav.logout(); return false;">üö™ Logout</a>
    </nav>
</div>

<!-- Main -->
<div class="main">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h2>üí≥ Payments</h2>
		<div>
			<button id="refreshBtn" class="btn btn-outline-primary"><i class="fas fa-rotate"></i> Refresh</button>
		</div>
	</div>

	<!-- Stats -->
	<div class="row g-3 mb-4">
		<div class="col-md-4">
			<div class="stat-card">
				<div class="d-flex justify-content-between align-items-center">
					<div>
						<div class="text-muted">Total Payments</div>
						<div id="statCount" class="h4 mb-0">0</div>
					</div>
					<i class="fas fa-receipt fa-2x text-primary"></i>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="stat-card">
				<div class="d-flex justify-content-between align-items-center">
					<div>
						<div class="text-muted">Total Quantity</div>
						<div id="statQty" class="h4 mb-0">0</div>
					</div>
					<span class="badge badge-soft">items</span>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="stat-card">
				<div class="d-flex justify-content-between align-items-center">
					<div>
						<div class="text-muted">Estimated Revenue</div>
						<div id="statRevenue" class="h4 mb-0">Rs. 0.00</div>
					</div>
					<i class="fas fa-coins fa-2x text-warning"></i>
				</div>
			</div>
		</div>
	</div>

	<!-- Table -->
	<div class="card">
		<div class="card-body">
			<div class="d-flex justify-content-between align-items-center mb-3">
				<h5 class="card-title mb-0">All Payments</h5>
				<input id="searchInput" type="text" class="form-control w-auto" placeholder="Search listing..." />
			</div>
			<div class="table-responsive">
				<table class="table table-hover align-middle">
					<thead>
						<tr>
							<th>#</th>
							<th>Listing</th>
							<th>Qty</th>
							<th>Unit Price (Rs.)</th>
							<th>Total (Rs.)</th>
						</tr>
					</thead>
					<tbody id="paymentsBody">
						<tr><td colspan="5" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="../assets/js/navigation.js"></script>
<script>
	const API_BASE = 'http://localhost:8080';

	function parseNumber(val) {
		const n = Number(val);
		return isNaN(n) ? 0 : n;
	}

	function computeTotal(unit, qty){
		const u = parseNumber(unit);
		return (u * (qty || 0));
	}

	async function loadPayments() {
		const tbody = document.getElementById('paymentsBody');
		const token = localStorage.getItem('accessToken');
		if (!token) {
			tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Not authenticated</td></tr>';
			return;
		}

		tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
		try {
			const res = await fetch(`${API_BASE}/api/admin/payments`, {
				headers: { 'Authorization': 'Bearer ' + token }
			});
			if (!res.ok) throw new Error('Failed to fetch payments');
			const payments = await res.json();

			// Stats
			document.getElementById('statCount').textContent = payments.length;
			const totalQty = payments.reduce((sum,p)=> sum + (p.quantity || 0), 0);
			document.getElementById('statQty').textContent = totalQty;
			const revenue = payments.reduce((sum,p)=> sum + computeTotal(p.price, p.quantity), 0);
			document.getElementById('statRevenue').textContent = 'Rs. ' + revenue.toFixed(2);

			// Render rows
			if (!payments.length) {
				tbody.innerHTML = '<tr><td colspan="5" class="text-center">No payments found</td></tr>';
				return;
			}
			const rows = payments.map((p, idx) => {
				const total = computeTotal(p.price, p.quantity);
				return `<tr>
					<td>${idx + 1}</td>
					<td>${p.listingName || '-'}</td>
					<td>${p.quantity ?? '-'}</td>
					<td>${p.price ?? '-'}</td>
					<td>${isNaN(total) ? '-' : total.toFixed(2)}</td>
				</tr>`;
			}).join('');
			tbody.innerHTML = rows;

			// Hook up search
			const input = document.getElementById('searchInput');
			input.oninput = () => {
				const q = input.value.toLowerCase();
				const filtered = payments.filter(p => (p.listingName||'').toLowerCase().includes(q));
				const rows = filtered.map((p, idx) => {
					const total = computeTotal(p.price, p.quantity);
					return `<tr>
						<td>${idx + 1}</td>
						<td>${p.listingName || '-'}</td>
						<td>${p.quantity ?? '-'}</td>
						<td>${p.price ?? '-'}</td>
						<td>${isNaN(total) ? '-' : total.toFixed(2)}</td>
					</tr>`;
				}).join('');
				tbody.innerHTML = rows || '<tr><td colspan="5" class="text-center">No matching results</td></tr>';
			};
		} catch (err) {
			console.error(err);
			tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load payments</td></tr>';
		}
	}

	document.getElementById('refreshBtn').addEventListener('click', loadPayments);
	document.addEventListener('DOMContentLoaded', loadPayments);
</script>
</body>
</html>
