<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AquaMart Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="../assets/css/responsive.css" rel="stylesheet" />
    <style>
      body {
        background: linear-gradient(135deg, #a7f3d0, #34d399);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: "Segoe UI", sans-serif;
      }
      .login-card {
        border-radius: 15px;
        overflow: hidden;
        max-width: 950px;
        width: 100%;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        background: linear-gradient(135deg, #ffffff, #ecfdf5);
      }
      .google-btn {
        border: 1px solid #10b981;
        background: #f0fdf4;
        color: #065f46;
      }
    </style>
  </head>
  <body>
    <div class="card login-card d-flex flex-row">
      <!-- Image Section -->
      <!--  <div class="col-md-6 d-none d-md-block p-0">-->
      <!--    <img src="/assets/images/img1.jpg" -->
      <!--         alt="AquaMart" -->
      <!--         class="img-fluid h-100 w-100" -->
      <!--         style="object-fit: cover; border-top-left-radius: 15px; border-bottom-left-radius: 15px;">-->
      <!--  </div>-->

      <!-- Form Section -->
      <div class="col-md-6 bg-white form-container">
        <h3 class="fw-bold text-primary">Welcome Back!</h3>
        <p class="text-muted">Login to your AquaMart account</p>

        <form>
          <div class="mb-3">
            <label for="email" class="form-label">Your Email</label>
            <input
              type="email"
              class="form-control"
              id="email"
              placeholder="name@gmail.com"
            />
          </div>
          <div class="mb-3">
            <label
              for="password"
              class="form-label d-flex justify-content-between"
            >
              <span>Password</span>
              <a href="forgetpassword.html" class="text-decoration-none small"
                >Forgot password?</a
              >
            </label>
            <input
              type="password"
              class="form-control"
              id="password"
              placeholder="****"
            />
          </div>
          <button class="btn btn-primary w-100 mb-3">Login</button>
          <button
            type="button"
            class="btn google-btn w-100 mb-3"
            id="googleLoginBtn"
          >
            <img
              src="https://cdn-icons-png.flaticon.com/512/281/281764.png"
              width="20"
              height="20"
              alt="Google"
            />
            SIGN IN WITH GOOGLE
          </button>
          <div class="text-center">
            <small
              >Not registered?
              <a href="signup.html" class="text-primary"
                >Create account</a
              ></small
            >
          </div>
        </form>
      </div>
    </div>

    <!-- JWT Decode -->
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        function extractRole(decoded) {
          if (!decoded) return "USER";
          if (decoded.roles && Array.isArray(decoded.roles)) {
            return decoded.roles[0]; // backend roles
          }
          return "USER";
        }

        function redirectByRole(role) {
          console.log("Redirecting for role:", role);
          if (role === "ADMIN") {
            window.location.href = "adminDashboard.html";
          } else if (role === "USER") {
            window.location.href = "dashboard.html";
          } else {
            Swal.fire(
              "Unknown Role",
              "We couldn’t determine your role.",
              "warning"
            );
          }
        }

        // ✅ Check if already logged in
        const token = localStorage.getItem("accessToken");
        if (token) {
          try {
            const decoded = jwt_decode(token);
            if (decoded.exp * 1000 > Date.now()) {
              const role = extractRole(decoded).toUpperCase();
              redirectByRole(role);
              return;
            } else {
              localStorage.clear();
            }
          } catch (error) {
            console.error("Invalid token:", error);
            localStorage.clear();
          }
        }

        // ✅ Handle login
        const form = document.querySelector("form");
        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value.trim();

          if (!email || !password) {
            Swal.fire("Missing Fields", "Please fill in all fields", "warning");
            return;
          }

          try {
            const response = await fetch(
              "http://localhost:8080/auth/aquamart/login",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Accept: "application/json",
                },
                body: JSON.stringify({ email, password }),
              }
            );

            // Try to parse JSON if present; otherwise capture text
            const contentType = response.headers.get("content-type") || "";
            let result = {};
            if (contentType.includes("application/json")) {
              try {
                result = await response.json();
              } catch (_) {
                result = {};
              }
            } else {
              const text = await response.text();
              result = { message: text };
            }

            if (!response.ok) {
              const status = response.status;
              // Specific handling for 401/403/0 (CORS/network)
              let msg =
                result.message ||
                (status === 0 ? "Network/CORS error" : "Login failed");
              if (status === 403) {
                msg =
                  "Forbidden (403). Please ensure the backend is running and CORS allows your origin.";
              } else if (status === 401) {
                msg = "Unauthorized (401). Check your email or password.";
              }
              Swal.fire("Login Failed", msg, "error");
              return;
            }

            if (result.data && result.data.token) {
              const token = result.data.token;
              localStorage.setItem("accessToken", token);

              const decoded = jwt_decode(token);
              const role = extractRole(decoded).toUpperCase();

              localStorage.setItem("userRole", role);
              localStorage.setItem(
                "userData",
                JSON.stringify({
                  id: decoded.userId,
                  email: decoded.sub,
                  role: role,
                  exp: decoded.exp,
                })
              );

              // ✅ Success alert
              Swal.fire({
                title: "Login Successful!",
                text: "Redirecting to your dashboard...",
                icon: "success",
                timer: 2000,
                showConfirmButton: false,
              }).then(() => {
                redirectByRole(role);
              });
            } else {
              // ❌ Error alert when no token in a 200 OK
              Swal.fire(
                "Login Failed",
                result.message || "Invalid credentials",
                "error"
              );
            }
          } catch (err) {
            console.error("Login error:", err);
            const msg = err?.message?.includes("Failed to fetch")
              ? "Cannot reach server. Check if backend is running on http://localhost:8080 and CORS/origin matches (http://127.0.0.1:5501)."
              : "Unexpected error occurred.";
            Swal.fire("Server Error", msg, "error");
          }
        });

        // ✅ Handle Google Login
        document
          .getElementById("googleLoginBtn")
          .addEventListener("click", function () {
            window.location.href =
              "http://localhost:8080/oauth2/authorization/google";
          });
      });
    </script>
  </body>
</html>
